{% extends "search_pages_results.html" %}

{% block more_style %}
<script type="text/javascript" src="{{script_name}}/javascript/jquery-1.3.2.min.js">
</script>

<script type="text/javascript">

var padding = 5;

var offset = 2; /* Think the 'a' tag around the thumbnail has a border
that shifts the thumbnail down and to the right a couple pixels... so
we do the same with the highlights */


function add_highlights(div) {
    var image = div.find(".thumbnail")
    var id = div.find("input[name='id']").attr("value");
    var words = div.find("input[name='words']").attr("value");
    var width = image.width();
    var height = image.height();
    if (width>0 && height>0) {
        $.each(words.split("+"), function(index, word) {
            // TODO: use % url tag bit
            $.getJSON('{{script_name}}'+id+'coordinates/;words='+word, function(all_coordinates) {
                    var boxes = [];
                    for (word in all_coordinates) {
                        var coordinates = all_coordinates[word];
                        for (k in coordinates) {
                            var v = coordinates[k];
                            div.append("<img class='highlite' src='{{script_name}}/images/red_60.png'" +
    "style='TOP: " +  (v["vpos"] * height - padding/2.0 + offset) + 'px;' +
    " LEFT: " +       (v["hpos"] * width - padding/2.0 + offset) + 'px;' +
    " HEIGHT: " +     (v["height"] * height + padding) + 'px;' +
    " WIDTH: " +      (v["width"] * width + padding) + "px;'/>");

                        }
                    }
                });
        });
    }
}


function initHighlights() {
  // add highlights after images load
  $("img.thumbnail").load(function(i) {
    var div = $(this).parents("div.highlite");
    add_highlights(div);
  });

  // add highlights for already loaded images
  // TODO: prevent from potentially adding highlights twice
  $("div.highlite").each(function(i) {
    var div = $(this);
    add_highlights(div);
  });
};

if ($.browser.msie && $.browser.version < 7) {
    window.onload = initHighlights;
} else {
    $(document).ready(initHighlights);
}

</script>

{% endblock %}

{% block results_type %}
          <a href="{% url chronam_search_pages_results_list view_type="list" %}?{{q}}&amp;page={{page.number}}&amp;sort={{sort}}">List View</a> | Thumbnail View 
{% endblock results_type %}


{% block search_results_box %}

    {% ifequal paginator.count 0 %}
    <h2>No Results</h2>
    {% else %}
    <div id="search_results_box">
        <div id="search_results_content">
            <div id="search_body">

                <table class="search_results">
                {% for row in paginator.results_table %}
                <tr>
                    {% for hit in row %}
                    <td>
                        {% if hit %}
                        <div class="highlite">
                            <a href="{{ hit.url }};words={{hit.words}}">
                             {% if hit.jp2_filename %} 
                              <img class="thumbnail" src="{{ hit.thumb_url }}" />
                             {% else %}
                              No Image
                             {% endif %} 
                          </a><br />
                    
                          <a href="{{ hit.url }};words={{hit.words}}">{{ hit }}</a>

                         <input name="id" value="{{hit.url}}" type="hidden"/>
                         <input name="words" value="{{hit.words}}" type="hidden"/>
                        </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
                </table>

            </div>
        </div>
    </div>
    {% endifequal %}

{% endblock %}
